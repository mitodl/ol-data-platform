---
version: 2

models:
- name: marts__combined__orders
  description: B2B and regular orders combined into one table
  columns:
  - name: platform
    description: string, describes which platform the data is from (mitxonline, mitxpro,
      or bootcamps)
  - name: order_id
    description: int, foreign key for order table
  - name: line_id
    description: int, foreign key for line table
  - name: order_created_on
    description: timestamp, specifying when the order was initially created. If this
      is a b2b order it will be the timestamp that order was created otherwise it
      will be when the regular order was created.
  - name: order_state
    description: string, order state. Options are "fulfilled", "failed", "created"
      "refunded"
  - name: courserun_id
    description: int, foreign key in courses_courserun
  - name: order_total_price_paid
    description: number, total order amount
  - name: product_id
    description: int, foreign key for product table
  - name: product_type
    description: string, readable product type
  - name: user_email
    description: str, user email associated with their account
  - name: user_id
    description: int, foreign key to the user table
  - name: user_id
    description: int, foreign key to the user table
  - name: b2b_only_indicator
    description: str, indicates whether the record is only related to a b2b order
  - name: coupon_id
    description: int, foreign key referencing ecommerce_coupon or the b2b coupon table
  - name: coupon_name
    description: string, human readable name for the coupon payment
  - name: receipt_authorization_code
    description: str, authorization code from cybersource payment
  - name: receipt_transaction_id
    description: string, unique identifier. Either the transaction_id from cybersource
      or a unique uuid
  - name: req_reference_number
    description: str, cybersource req reference number for a payment
  tests:
  - dbt_expectations.expect_compound_columns_to_be_unique:
      column_list: ["order_id", "line_id", "b2b_only_indicator", "platform", "coupon_id"]

- name: marts__combined_course_enrollment_detail
  description: course enrollment detail with certificates, orders and coupons from
    OL platforms.
  config:
    grants:
      select: ['finance']
  columns:
  - name: platform
    description: string, application where the data is from
    tests:
    - not_null
    - accepted_values:
        values: '{{ var("platforms") }}'
  - name: courserunenrollment_id
    description: int, internal ID and foreign key to courserunenrollments on the corresponding
      platform. Null for enrollments on edX.org.
  - name: courserunenrollment_is_active
    description: boolean, indicating whether the enrollment is active
    tests:
    - not_null
  - name: user_id
    description: int, user ID on the corresponding platform
    tests:
    - not_null
  - name: courserun_id
    description: int, primary key representing a single course run on the corresponding
      platform. Null for course runs from edx.org
  - name: courserunenrollment_created_on
    description: timestamp, specifying when the enrollment was initially
    tests:
    - not_null
  - name: courserunenrollment_enrollment_mode
    description: string, enrollment mode for user on the corresponding platform
  - name: courserunenrollment_enrollment_status
    description: string, enrollment status for users whose enrollment changed on the
      corresponding platform
  - name: courserunenrollment_is_edx_enrolled
    description: boolean, indicating whether the user is enrolled on edX platform.
      For edx.org course enrollment, it would always be true. Null for Bootcamps as
      it doesn't apply.
  - name: courserun_title
    description: string, title of the course run on the corresponding platform. Maybe
      blank for a few edX.org runs missing in int__edxorg__mitx_courseruns.
  - name: courserun_readable_id
    description: str, unique string to identify a course run on the corresponding
      platform
  - name: courserun_start_on
    description: timestamp, date and time when the course starts
  - name: user_username
    description: string, username to identify a user on the corresponding platform
    tests:
    - not_null
  - name: user_email
    description: string, user email that user registered on the corresponding platform
    tests:
    - not_null
  - name: user_full_name
    description: str, user full name from user's profile on the corresponding platform
  - name: user_country_code
    description: str, country code from the user's address on the corresponding platform
  - name: courseruncertificate_uuid
    description: str, unique identifier for the certificate on the corresponding platform
  - name: courseruncertificate_url
    description: str, URL to the course certificate for users who earned the certificate.
      This could be blank for revoked certificate.
  - name: courseruncertificate_created_on
    description: timestamp, date and time when the course certificate was initially
      created
  - name: order_id
    description: int, unique identifier/foreign key to ecommerce orders from the corresponding
      platform
  - name: order_state
    description: string, order state from the corresponding platform. It doesn't include
      'created' order state
  - name: order_created_on
    description: timestamp, specifying when the order was initially created
  - name: order_reference_number
    description: string, order reference number to identify an order on the corresponding
      platform, e.g. mitxonline-production-20
  - name: order_total_price_paid
    description: number, total order amount for the order
  - name: unit_price
    description: numeric, price for the order line item before discount
  - name: coupon_discount_amount
    description: str, discount amount in readable format. e.g. $100 off, 30% off,
      etc
  - name: coupon_code
    description: str, discount code for the redeemed coupon if applicable
  - name: coupon_redeemed_on
    description: timestamp, specifying when the discount was redeemed by the user
  - name: payment_transaction_id
    description: str, transaction ID from cybersource payment
  - name: payment_req_reference_number
    description: str, req_reference_number from cybersource payment
  - name: payment_bill_to_address_state
    description: str, address state from cybersource payment receipt
  - name: payment_bill_to_address_country
    description: str, address country from cybersource payment receipt
  - name: order_tax_country_code
    description: str, the country code where the tax was applied. Only applicable
      for xPro for now.
  - name: order_tax_rate
    description: numeric, the tax rate to apply. Only applicable for xPro for now.
  - name: order_tax_rate_name
    description: string, name of the tax rate assessed. Only applicable for xPro for
      now.
  - name: order_tax_amount
    description: numeric, the amount of tax paid. Only applicable for xPro for now.
  - name: order_total_price_paid_plus_tax
    description: numeric, total order amount plus the amount of tax paid. For xPro,
      this is calculated order_total_price_paid+order_tax_amount. For other platform,
      this is the same as order_total_price_paid
  tests:
  - dbt_expectations.expect_compound_columns_to_be_unique:
      column_list: ["user_username", "courserun_readable_id"]
      row_condition: "platform='edX.org'"
  - dbt_expectations.expect_compound_columns_to_be_unique:
      column_list: ["courserunenrollment_id"]
      row_condition: "platform ='MITx Online'"
  - dbt_expectations.expect_compound_columns_to_be_unique:
      column_list: ["courserunenrollment_id"]
      row_condition: "platform ='xPro'"
  - dbt_expectations.expect_compound_columns_to_be_unique:
      column_list: ["courserunenrollment_id", "order_reference_number"]
      row_condition: "platform='Bootcamps'"
